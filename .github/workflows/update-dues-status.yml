name: Update Dues Status

on:
  # Run every minute (GitHub Actions minimum schedule interval)
  schedule:
    - cron: '* * * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  update-status:
    runs-on: ubuntu-latest
    
    steps:
      - name: Call Dues Status Update Function (30-second intervals)
        run: |
          # Function to call the edge function
          call_function() {
            echo "Calling dues status update at $(date)"
            
            response=$(curl -s -w "\n%{http_code}" -X POST \
              "https://ptshejpesjthpunoooxe.supabase.co/functions/v1/update-dues-status" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0c2hlanBlc2p0aHB1bm9vb3hlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0Mjk4MTcsImV4cCI6MjA2NDAwNTgxN30.BBrgDUGbmj0rPzNc3aOF5bHkEsE3cm5gEO8MPD3pNWQ" \
              -d "{\"scheduled\": true, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}")
            
            # Extract status code (last line)
            status_code=$(echo "$response" | tail -n1)
            # Extract body (all but last line)
            body=$(echo "$response" | sed '$d')
            
            echo "Status code: $status_code"
            echo "Response: $body"
            
            if [ "$status_code" -eq 200 ]; then
              echo "✅ Dues status update completed successfully"
            else
              echo "⚠️ Dues status update failed with status code: $status_code"
              return 1
            fi
          }
          
          # Call the function twice with 30-second interval
          # This achieves the 30-second frequency within the 1-minute GitHub Actions schedule
          
          echo "=========================="
          echo "First call (0 seconds)"
          echo "=========================="
          call_function
          
          echo ""
          echo "Waiting 30 seconds..."
          sleep 30
          
          echo ""
          echo "=========================="
          echo "Second call (30 seconds)"
          echo "=========================="
          call_function
          
          echo ""
          echo "Job completed successfully"

      - name: Log completion
        if: always()
        run: |
          echo "Dues status update workflow completed at $(date)"
